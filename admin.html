<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="common.js"></script>
  <style>
    .stats-container {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 10px; /* for scrollbar space */
    }
    #adminPassword {
      background: #ffffff !important;
      border: 1px solid #ccc !important;
      color: #000000 !important;
      padding: 0.5rem !important;
      border-radius: 4px !important;
      font-size: 1rem !important;
    }
  </style>
</head>
<body class="admin">
  <div class="bubbles">
    <span style="--i:11"></span>
    <span style="--i:17"></span>
    <span style="--i:25"></span>
    <span style="--i:14"></span>
    <span style="--i:22"></span>
    <span style="--i:16"></span>
    <span style="--i:10"></span>
    <span style="--i:18"></span>
    <span style="--i:26"></span>
    <span style="--i:13"></span>
  </div>
  <div class="container" role="main" style="background-color: transparent; padding: 1rem; border-radius: 8px;">
    <h1>Admin Dashboard</h1>
    <div id="loginSection">
      <label for="adminPassword">Enter Admin Password:</label>
      <input type="password" id="adminPassword" aria-label="Admin Password" style="background: rgba(255, 255, 255, 0.7); border: none; border-radius: 4px; padding: 0.5rem; font-size: 1rem; color: #333;"/>
      <button id="loginBtn" class="animated-button" style="background-color: rgba(0, 123, 255, 0.8); color: white; border: none; border-radius: 4px; padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer;">Login</button>
      <p id="loginMessage" class="error" aria-live="polite"></p>
    </div>

    <div id="dashboard" style="display:none;">
      <h2>Ticket Statistics</h2>
      <div class="stats-container">
        <div class="stat-item">
          <p>Total Tickets Booked:</p>
          <p class="stat-number" id="totalTickets">0</p>
        </div>
        <div class="stat-item">
          <p>Tickets by Route and Type:</p>
          <ul id="ticketsByRouteType" class="animated-list"></ul>
        </div>
        
      </div>
      <button id="resetBtn" class="animated-button">Reset All Tickets</button>
      <p id="resetMessage" class="message" aria-live="polite"></p>
    </div>
  </div>

  <script>
    const ADMIN_PASSWORD = "templeadmin123"; // Basic password protection

    document.addEventListener('DOMContentLoaded', () => {
      const loginSection = document.getElementById('loginSection');
      const dashboard = document.getElementById('dashboard');
      const loginBtn = document.getElementById('loginBtn');
      const loginMessage = document.getElementById('loginMessage');
      const totalTicketsEl = document.getElementById('totalTickets');
      const ticketsByRouteTypeEl = document.getElementById('ticketsByRouteType');
      // const scannedTicketsText = document.getElementById('scannedTicketsText');
      // const scannedTicketsCircle = document.querySelector('.circle');
      const resetBtn = document.getElementById('resetBtn');
      const resetMessage = document.getElementById('resetMessage');

      loginBtn.addEventListener('click', () => {
        const password = document.getElementById('adminPassword').value;
        if (password === ADMIN_PASSWORD) {
          loginSection.style.display = 'none';
          dashboard.style.display = 'block';
          loadStats();
        } else {
          loginMessage.textContent = "Incorrect password.";
        }
      });

      function animateCountUp(element, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          element.textContent = Math.floor(progress * (end - start) + start);
          if (progress < 1) {
            window.requestAnimationFrame(step);
          }
        };
        window.requestAnimationFrame(step);
      }

      function setProgress(percent) {
        const radius = 15.9155;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (percent / 100) * circumference;
        scannedTicketsCircle.style.strokeDasharray = `${circumference - offset} ${offset}`;
        scannedTicketsText.textContent = `${percent}%`;
      }

        function loadStats() {
          try {
            const tickets = getAllTicketsForAllUsers();

            animateCountUp(totalTicketsEl, 0, tickets.length, 1500);

            // Count by route and type
            const counts = {};
            tickets.forEach(t => {
              const key = `${t.route} - ${t.type}`;
              counts[key] = (counts[key] || 0) + 1;
            });

            // Remove specific entries from counts
            delete counts["Tirupati ↔ Tirumala - one-way"];
            delete counts["Tirupati ↔ Tirumala - two-way"];

            ticketsByRouteTypeEl.innerHTML = '';
            for (const [key, count] of Object.entries(counts)) {
              const li = document.createElement('li');
              li.textContent = `${key}: ${count}`;
              ticketsByRouteTypeEl.appendChild(li);
            }

            // Count scanned tickets
            const scannedCount = tickets.filter(t => t.scansUsed > 0).length;
            const scannedPercent = tickets.length > 0 ? Math.round((scannedCount / tickets.length) * 100) : 0;
            // animateCountUp(scannedTicketsText, 0, scannedPercent, 1500);
            // setProgress(scannedPercent);
          } catch (error) {
            resetMessage.textContent = "Error loading stats: " + error.message;
          }
        }

      resetBtn.addEventListener('click', () => {
        resetMessage.textContent = "Resetting all tickets...";
        try {
          resetAllTicketsForAllUsers();
          resetMessage.textContent = "All tickets reset.";
          loadStats();
        } catch (error) {
          resetMessage.textContent = "Error resetting tickets: " + error.message;
        }
      });
    });
  </script>
</body>
</html>